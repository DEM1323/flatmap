<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immersive Room - Grid Layout (4x2)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000; color: white;
            font-family: sans-serif;
        }

        /* The 4x2 Projector Grid (Actual Output) */
        #projector-grid {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            display: none; 
            z-index: 100;
            background: #000;
        }

        #canvas-container { width: 100vw; height: 100vh; }

        .ui-panel {
            position: absolute; top: 20px; left: 20px;
            background: rgba(10, 10, 10, 0.95);
            padding: 20px; border-radius: 12px;
            border: 1px solid #00f2ff; z-index: 200;
            width: 320px; box-shadow: 0 0 20px rgba(0, 242, 255, 0.3);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .ui-panel.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px);
        }

        .btn {
            display: block; width: 100%; padding: 12px;
            background: #00f2ff; color: #000; border: none;
            border-radius: 6px; cursor: pointer; font-weight: bold;
            margin-bottom: 10px; text-transform: uppercase;
        }
        .btn:hover { background: #fff; }

        .control-group { margin-bottom: 15px; border-top: 1px solid #333; padding-top: 10px; }
        label { display: block; font-size: 12px; margin-bottom: 5px; color: #888; }
        
        .grid-preview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 2px;
            background: #333;
            margin-top: 10px;
            padding: 2px;
        }
        .grid-preview div {
            aspect-ratio: 16/9;
            background: #111;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
            border: 1px solid #222;
        }
        .grid-preview div.active {
            background: #004444;
            color: #00f2ff;
            border-color: #00f2ff;
        }
        .shortcut-hint {
            font-size: 10px;
            color: #666;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div class="ui-panel" id="main-ui">
        <h2 style="margin: 0 0 5px 0; font-size: 18px;">4x2 Matrix Controller</h2>
        <p style="font-size: 11px; color: #00f2ff; margin-bottom: 15px;">Output: 7680 x 2160 px</p>
        
        <button class="btn" onclick="toggleMode()">Projector Output Mode</button>
        
        <div class="control-group">
            <label>Calibration Grid Intensity</label>
            <input type="range" min="0" max="100" value="50" style="width:100%" oninput="updateGridOpacity(this.value)">
        </div>

        <div class="control-group">
            <label>OS Display Mapping (Expected)</label>
            <div class="grid-preview">
                <div class="active">W1</div>
                <div class="active">W2</div>
                <div class="active">W3</div>
                <div class="active">W4</div>
                <div class="active">F5</div>
                <div>--</div>
                <div>--</div>
                <div>--</div>
            </div>
            <p style="font-size: 10px; color: #666; margin-top: 10px; line-height: 1.4;">
                Floor (5) is mapped to bottom-left quadrant.
            </p>
        </div>
        
        <button class="btn" style="background: #333; color: white;" onclick="resetCamera()">Reset 3D View</button>
        <div class="shortcut-hint">Press <b>'H'</b> to hide/show this panel</div>
    </div>

    <canvas id="projector-grid"></canvas>
    <div id="canvas-container"></div>

    <script>
        let scene, camera, renderer, controls, cubeGroup;
        let pCanvas, pCtx, pTexture;
        let isProjectionMode = false;
        let gridOpacity = 0.5;
        let uiVisible = true;

        const DISPLAY_W = 1920;
        const DISPLAY_H = 1080;
        const CANVAS_W = DISPLAY_W * 4; 
        const CANVAS_H = DISPLAY_H * 2; 

        function init() {
            setupProjectorCanvas();
            setup3DScene();
            setupKeyboardShortcuts();
            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function setupProjectorCanvas() {
            pCanvas = document.getElementById('projector-grid');
            pCanvas.width = CANVAS_W; 
            pCanvas.height = CANVAS_H;
            pCtx = pCanvas.getContext('2d');
            pTexture = new THREE.CanvasTexture(pCanvas);
            pTexture.minFilter = THREE.LinearFilter;
        }

        function setup3DScene() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(3, 2, 4);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            cubeGroup = new THREE.Group();
            const wW = 1.92; const wH = 1.08;
            const hW = wW/2; const hH = wH/2;

            // UV Mappings for the 4x2 grid
            // Wall 1-4: Top row (v: 0.5 to 1.0)
            // Floor 5: Bottom row, under Wall 1 (v: 0.0 to 0.5, u: 0.0 to 0.25)
            const wall1 = createPanel(wW, wH, 0.00, 0.25, 0.5, 1.0); 
            const wall2 = createPanel(wW, wH, 0.25, 0.50, 0.5, 1.0); 
            const wall3 = createPanel(wW, wH, 0.50, 0.75, 0.5, 1.0); 
            const wall4 = createPanel(wW, wH, 0.75, 1.00, 0.5, 1.0); 
            const floor = createPanel(wW, wW, 0.00, 0.25, 0.0, 0.5); 

            wall1.position.set(-hW, 0, 0); wall1.rotation.y = Math.PI/2;
            wall2.position.set(0, 0, -hW); 
            wall3.position.set(hW, 0, 0); wall3.rotation.y = -Math.PI/2;
            wall4.position.set(0, 0, hW); wall4.rotation.y = Math.PI;
            floor.position.set(0, -hH, 0); floor.rotation.x = -Math.PI/2;

            cubeGroup.add(wall1, wall2, wall3, wall4, floor);
            scene.add(cubeGroup);
        }

        function createPanel(w, h, uMin, uMax, vMin, vMax) {
            const geo = new THREE.PlaneGeometry(w, h);
            const uv = geo.attributes.uv;
            for (let i = 0; i < uv.count; i++) {
                let u = uv.getX(i);
                let v = uv.getY(i);
                uv.setXY(i, uMin + u * (uMax - uMin), vMin + v * (vMax - vMin));
            }
            return new THREE.Mesh(geo, new THREE.MeshBasicMaterial({ map: pTexture, side: THREE.DoubleSide }));
        }

        function setupKeyboardShortcuts() {
            window.addEventListener('keydown', (e) => {
                if (e.key.toLowerCase() === 'h') {
                    uiVisible = !uiVisible;
                    const panel = document.getElementById('main-ui');
                    if (uiVisible) {
                        panel.classList.remove('hidden');
                    } else {
                        panel.classList.add('hidden');
                    }
                }
                
                if (e.key === 'Escape' && isProjectionMode) {
                    toggleMode();
                }
            });
        }

        function drawContent() {
            const time = Date.now() * 0.001;
            pCtx.fillStyle = '#000';
            pCtx.fillRect(0, 0, pCanvas.width, pCanvas.height);

            // Panoramic Content (Top Row)
            const topW = CANVAS_W;
            const topH = DISPLAY_H;
            pCtx.strokeStyle = 'rgba(0, 242, 255, 0.15)';
            pCtx.lineWidth = 1;
            for(let x=0; x < topW; x += 150) {
                let offset = (time * 60) % 150;
                pCtx.beginPath();
                pCtx.moveTo(x + offset, 0);
                pCtx.lineTo(x + offset, topH);
                pCtx.stroke();
            }

            pCtx.fillStyle = '#fff';
            pCtx.font = "bold 110px sans-serif";
            const textX = (time * 190) % (topW + 3000) - 1500;
            pCtx.fillText("INTERFACE ACTIVE • WRAP-AROUND CALIBRATION • SEAMLESS GRID READY • ", textX, topH/2);

            // Floor Content (Bottom Left)
            pCtx.save();
            pCtx.translate(DISPLAY_W/2, DISPLAY_H + DISPLAY_H/2);
            pCtx.strokeStyle = '#00f2ff';
            pCtx.lineWidth = 4;
            pCtx.beginPath();
            pCtx.arc(0, 0, 250 + Math.sin(time*2.5)*40, 0, Math.PI*2);
            pCtx.stroke();
            pCtx.fillStyle = '#00f2ff';
            pCtx.font = "45px monospace";
            pCtx.textAlign = "center";
            pCtx.fillText("CORE FLOOR SECTOR", 0, 0);
            pCtx.restore();

            // Calibration UI
            pCtx.strokeStyle = `rgba(0, 242, 255, ${gridOpacity})`;
            pCtx.lineWidth = 6;
            pCtx.font = "bold 70px sans-serif";
            const panels = [
                {id: "WALL 1", x: 0, y: 0},
                {id: "WALL 2", x: DISPLAY_W, y: 0},
                {id: "WALL 3", x: DISPLAY_W*2, y: 0},
                {id: "WALL 4", x: DISPLAY_W*3, y: 0},
                {id: "FLOOR 5", x: 0, y: DISPLAY_H} 
            ];

            panels.forEach(p => {
                pCtx.strokeRect(p.x + 20, p.y + 20, DISPLAY_W - 40, DISPLAY_H - 40);
                pCtx.fillStyle = `rgba(0, 242, 255, ${gridOpacity})`;
                pCtx.fillText(p.id, p.x + 100, p.y + 150);
                pCtx.beginPath();
                pCtx.moveTo(p.x + DISPLAY_W/2 - 60, p.y + DISPLAY_H/2);
                pCtx.lineTo(p.x + DISPLAY_W/2 + 60, p.y + DISPLAY_H/2);
                pCtx.moveTo(p.x + DISPLAY_W/2, p.y + DISPLAY_H/2 - 60);
                pCtx.lineTo(p.x + DISPLAY_W/2, p.y + DISPLAY_H/2 + 60);
                pCtx.stroke();
            });

            pTexture.needsUpdate = true;
        }

        function toggleMode() {
            isProjectionMode = !isProjectionMode;
            pCanvas.style.display = isProjectionMode ? 'block' : 'none';
            document.getElementById('canvas-container').style.display = isProjectionMode ? 'none' : 'block';
            
            // Added catch block to handle permission policy restrictions on fullscreen
            if (isProjectionMode && document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.warn("Fullscreen disabled by browser policy/sandbox.");
                });
            } else if (!isProjectionMode && document.exitFullscreen && document.fullscreenElement) {
                document.exitFullscreen().catch(() => {});
            }
        }

        function updateGridOpacity(val) { gridOpacity = val / 100; }
        function resetCamera() { controls.reset(); camera.position.set(3, 2, 4); }
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            drawContent();
            if (!isProjectionMode) controls.update();
            renderer.render(scene, camera);
        }

        window.onload = init;
    </script>
</body>
</html>
